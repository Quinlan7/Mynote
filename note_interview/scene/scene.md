# 技术场景面试题

[TOC]

## 一、我的项目中的技术难点

### 1.1 慢SQL优化

**P：**这个是在我们接手的地道项目中遇到的问题，当时的一个大屏的展示功能接口，基本是在五分钟左右才会有响应，当时是要求我们优化这个接口的响应速度。

**A：**

+ **定位**：我们定位到了这个接口中的两个sql执行很慢基本在两三分钟。这两个sql都是查询的一张表，一个是设备在线的数据，一个是设备不在线的数据。我在 navicat 中执行对应的sql，发现很慢。
+ **解决：**
  + 首先，我先看了下数据量，是由三千多万的数据，并且没有主键，我觉得可能是数据量太大了，这种情况加索引也是很费时间的，我通过几个列查了一下发现有两千多万的重复的数据，这是因为这个表是记录地道水位高度的，传感器的更新频率并不稳定，有的一分多有的两分钟更新一次，然后我们的定时任务是一分钟一执行的，所以我先写了个循环删除数据的sql，一次50w然后commit，删除完数据之后，通过oracle Scheduler写了个定时任务，定时删除重复的数据。可以sql执行时间还是不理想，所以应该不是数据量的问题。 
  + 然后想到的都是优化sql语句，可以它的sql语句并不复杂，没有联表，只是有个日期的where，和聚合函数。但是这个日期字段他是个String，它使用了toDate函数将所有日期转为Date类型判断的，我没有想到什么好的方法可以处理这个String的日期字段，然后我就先尝试优化这个聚合函数，我是把这个查询作为了子查询，把聚合函数提出到外层，进行尝试。第一次执行我发现就几百毫秒，很意外，我还以为优化很有效呢，但是我多尝试了几次就发现，这个sql的执行时间是不稳定的，它大多数时间还是要三分钟才能执行完毕。然后我就觉得可能主要问题是锁，可能是每分钟的定时任务插入数据的时候都上了行锁，然后sql查询的也是最新的一段时间的数据，可能导致了慢sql。
  + 然后我使用了物化视图（使用中，我发现只有对应模式的用户可以创建物化视图，即使是管理员也没有权限，即使管理员给自己赋权也不能）使插入和检索分离开，并且将String类型的日期在物化视图中改为Date类型的，且只在物化视图中保留必要的字段，大大提高了检索速度，然后也是使用定时任务来更新物化视图。

**R：**优化之后整体接口的速度基本在五百毫秒左右，响应速度大幅提升，但是相应的实时性上要比之前差一点，因为是定时更新的物化视图嘛。