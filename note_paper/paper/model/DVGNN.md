# Dynamic Causal Explanation Based Diffusion-Variational Graph Neural Network for Spatio-temporal Forecasting

基于动态因果解释的扩散变分图神经网络用于时空预测

## Abstract

*Graph neural networks (GNNs), especially dynamic GNNs, have become a research hotspot in spatio-temporal forecasting problems. While many dynamic graph construction methods have been developed, relatively few of them explore the causal relationship between neighbour nodes. Thus, the resulting models lack strong explainability for the causal relationship between the neighbour nodes of the dynamically generated graphs, which can easily lead to a risk in subsequent decisions. Moreover, few of them consider the uncertainty and noise of dynamic graphs based on the time series datasets, which are ubiquitous in realworld graph structure networks. In this paper, we propose a novel Dynamic Diffusion-Variational Graph Neural Network (DVGNN) for spatio-temporal forecasting. For dynamic graph construction, an unsupervised generative model is devised. Two layers of graph convolutional network (GCN) are applied to calculate the posterior distribution of the latent node embeddings in the encoder stage. Then, a diffusion model is used to infer the dynamic link probability and reconstruct causal graphs in the decoder stage adaptively. The new loss function is derived theoretically, and the reparameterization trick is adopted in estimating the probability distribution of the dynamic graphs by Evidence Lower Bound (ELBO) during the backpropagation period. After obtaining the generated graphs, dynamic GCN and temporal attention are applied to predict future states. Experiments are conducted on four real-world datasets of different graph structures in different domains. The results demonstrate that the proposed DVGNN model outperforms state-of-the-art approaches and achieves outstanding Root Mean Squared Error (RMSE) result while exhibiting higher robustness. Also, by F1-score and probability distribution analysis, we demonstrate that DVGNN better reflects the causal relationship and uncertainty of dynamic graphs. The website of the code is https://github.com/gorgen2020/DVGNN.*

图神经网络（GNNs），尤其是动态GNNs，已成为时空预测问题中的研究热点。虽然已经开发了许多动态图构建方法，但相对较少的方法探索了相邻节点之间的因果关系。因此，由==动态生成的图的相邻节点之间的因果关系==解释性较弱，可能会在后续决策中带来风险。此外，很少有方法考虑到==基于时间序列数据集的动态图的不确定性和噪声==，这在实际世界的图结构网络中是普遍存在的。在本文中，我们提出了一种新颖的动态扩散-变分图神经网络（DVGNN）用于时空预测。对于动态图构建，设计了一个无监督的生成模型。在编码器阶段应用了两层图卷积网络（GCN）来计算潜在节点嵌入的后验分布。然后，在解码器阶段采用扩散模型来推断动态链接概率并自适应地重建因果图。新的损失函数从理论上推导出，并且在反向传播期间通过证据下界（ELBO）采用了重新参数化技巧来估计动态图的概率分布。在获得生成的图后，应用动态GCN和时间注意力来预测未来状态。我们在不同领域具有不同图结构的四个真实世界数据集上进行了实验。结果表明，所提出的DVGNN模型优于最先进的方法，并取得了出色的均方根误差（RMSE）结果，同时具有更高的鲁棒性。此外，通过F1分数和概率分布分析，我们证明了DVGNN更好地反映了动态图的因果关系和不确定性。代码网站为https://github.com/gorgen2020/DVGNN。

## 1.介绍

*S PATIO-TEMPORAL forecasting is a core issue in many applications, such as neuroscience, transportation, healthcare, etc. With the rapid growth of time series datasets generated by different domains, spatio-temporal forecasting is also becoming central to many fields of scientific research. However, owing to the fast-changing and complex correlation of spatio-temporal data, it is often challenging to discover the causal relationship and achieve high-accuracy prediction. Moreover, many collected data have complex graph structures and are noisy, making the problem more difficult. Traditional time series forecasting models, such as Auto-Regressive Integrated Moving Average (ARIMA) [1] and Vector AutoRegression (VAR) [2], Hidden Markov Model (HMM) [3] and Support Vector Regression (SVR) [4] are of great interpretability and low computational complexity. However, they ignore the spatial features and require manual feature engineering, which is not suitable for big data application scenarios.*

时空预测是许多应用中的核心问题，例如神经科学、交通运输、医疗保健等。随着不同领域生成的时间序列数据集的快速增长，时空预测也逐渐成为科学研究许多领域的核心问题。

然而，由于时空数据的快速变化和复杂相关性，发现因果关系并实现高精度预测通常是具有挑战性的。

此外，许多收集到的数据具有复杂的图结构，并且存在噪音，使得问题变得更加困难。传统的时间序列预测模型，如自回归积分移动平均模型（ARIMA）、向量自回归模型（VAR）、隐马尔可夫模型（HMM）和支持向量回归（SVR）具有很好的解释性和低计算复杂度。然而，它们忽视了空间特征，并且需要手动特征工程，不适用于大数据应用场景。



随着神经网络在大数据时代的发展，预测精度得到了极大的提升。许多学者将深度学习方法应用于时间序列预测和因果发现问题。Temporal Causal Discovery Framework (TCDF) 应用了卷积神经网络 (CNN) 和注意力机制来发现时间序列的因果图。神经 Granger 因果性 (NGC) 模型利用多层感知器 (MLP) 和长短期记忆 (LSTM) 对每个时间序列进行建模，用于 Granger 因果性和预测。因果循环变分自编码器 (CR-VAE) 将 Granger 因果性的概念集成到循环变分自编码器框架中，用于因果发现和预测。然而，这些因果发现模型侧重于捕获时间特征，在处理非欧几里德图结构数据时经常失败。因此，在时空预测问题中，它们的预测性能较低。为了捕获时间序列数据的非欧几里德图结构特征，图神经网络 (GNNs) 被设计用于处理具有图结构的数据的神经网络。GNN 的关键设计是使用成对消息传递，通过与其邻居交换信息来表示节点嵌入。虽然 GNN 在提取图的空间特征方面取得了巨大成功，但传统的 GNN 方法通常采用静态图，忽视了现实中边的复杂性、不断变化性和通常的非线性。幸运的是，越来越多的学者意识到了这个问题，并尝试通过各种方法构建动态图来进一步表示时空特征。

However, most of the dynamic graph methods belong to the class of discriminative models and learn the deterministic node features, which ignores the uncertainty of graph-structure data and the underlying stochastic generative process of the time series. Also, various noises are ubiquitous in real time series data, which makes it difficult to obtain real causal relationship and high-accuracy prediction. For example, Fig. 1a depicts three connected roads, traffic flow shuttle between Road 2 and Road 3 while neither of them interacts with Road 1 as Origin and Destination (OD) red arrows indicate. As time elapses, trip patterns between Road 2 and Road 3 will get a high correlation and cause changes between their respective traffic flows. In turn, that results in a strong edge connecting the two roads in a graph representation. On the other hand, Road 1 has little interaction with them, which results in weak edges, or complete disconnection to Roads 2 and 3. In addition, from the trajectories points of the vehicles shown as the red circles on the map, points of Road 2 are denser than those of Road 3 at time t and mainly cause the “positive” traffic flow change of Road 3 at time t + T. The actual traffic speeds of the three roads are shown in Fig. 1b. Unfortunately, as shown in the observed traffic speeds curve of Fig. 1c, due to the reliability of sensors or other unstable factors of traffic condition, the node signals collected by the sensors show certain uncertainty and stochasticity in reality and are prone to fluctuation affected by the impact of noise, which make it hard to discover this causal relationship. Therefore, it is more reasonable to consider the transition of OD as a stochastic process with noise

然而，大多数动态图方法属于判别模型的类别，学习确定性节点特征，忽视了图结构数据的不确定性和时间序列的基础随机生成过程。此外，实时时间序列数据中存在各种噪声，这使得难以获得真实的因果关系和高精度的预测。例如，图1a描述了三条连接的道路，交通流在道路2和道路3之间穿梭，而它们都不与道路1交互，如图中的红色箭头所示。随着时间的推移，道路2和道路3之间的行程模式将产生很高的相关性，并导致它们各自的交通流量发生变化。反过来，这导致了在图表示中连接两条道路的强边。另一方面，道路1与它们的交互很少，这导致了较弱的边缘，或者完全与道路2和道路3断开连接。此外，从地图上显示的车辆轨迹点（红色圆圈）来看，在时间t时，道路2的点比道路3的点更密集，并且主要引起了时间t + T时道路3的“正向”交通流量的变化。三条道路的实际交通速度如图1b所示。不幸的是，如图1c所示的观察到的交通速度曲线，由于传感器的可靠性或交通条件的其他不稳定因素，传感器收集到的节点信号在现实中显示出一定的不确定性和随机性，并且容易受到噪声影响而波动，这使得难以发现这种因果关系。因此，更合理的做法是将 OD 的转换视为一个带有噪声的随机过程



为了解决上述问题，受物理学中随机过程的启发，我们提出了一种新颖的生成式和无监督学习的动态图框架，即Dynamic Diffusion-Variational Graph Neural Network（DVGNN），用于时空预测。它通过优化随机微分方程（SDE）的变分下界来发现因果关系，以获得更准确的预测结果和对生成图的更好解释能力。本文的主要贡献如下：

• 提出了一种新颖的DVGNN用于时空预测。DVGNN在编码器阶段采用了两层GCNs，并通过解码器阶段的扩散过程来发现邻居节点的因果关系。

• 在扩散过程中，通过噪声驱动的SDE对时空数据的不确定性和噪声进行了建模。推导并理论上近似了邻居节点的动态因果关系。

• 我们对不同领域、不同图结构的四个真实世界数据集进行了实验。实验结果表明，与现有模型相比，DVGNN在时空预测中具有更高的优越性。此外，我们分析了预测的动态边缘的不确定性、模型的鲁棒性以及生成图的可解释性。



## 3.前言

为了方便后续讨论，我们引入以下关键定义：

定义1：图 G。大多数时空网络可以表示为一个图 G = (V; E; A)，其中 V 是图中的节点集合，V = {v1, v2, ..., vN}，N 是图中节点的总数。E 是节点之间的边集合。我们采用邻接矩阵 A 来表示节点之间的连接关系。为了方便后续讨论，定义 $\bar{A} $ 代表编码器阶段观测数据的图结构，$ A_{causal}$ 用于表示因果关系图，而 $A_{trans}$ 用于表示多步预测的==转移密度概率图==。特别地，¯A、Acausal 和 Atrans 都是 N×N 的加权图矩阵。

>  $A_{trans}$ 用于表示多步预测的==变换密度概率图==???   transition density probability graph 



定义 2：特征矩阵 X。节点信息包含各种信息，可以表示为矩阵 X，其中 $X ∈ ℝ^{N×F}$，F 是输入特征的维度。在本研究中，为了表示时间序列的特征，使用 $X_t ∈ ℝ^{N×F}$ 表示时间 t 时所有节点 V 的所有输入特征。因此，每个属性的历史 p 个时间步的值形成特征矩阵 $X_{t−p:t−1} = [X_{t−p}, ..., X_{t−2}, X_{t−1}]$，相应地 $X_{t−p:t−1} ∈ ℝ^{N×F×p}$。

本文中，使用观测到的图结构数据进行时空预测的目标是推断时间序列的因果关系图，并根据过去 p 个历史时间步预测未来 T0 个时间步。其数学表述如下：



![image-20240415171909906](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404151719008.png)





## 4.网络结构

DVGNN 的总体框架如图 2 所示。

![image-20240415193414790](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404151934977.png)

DVGNN架构概述：(a)是编码器组件，包括两个GCN层，用于学习潜在节点嵌入Zt。(b)是解码器组件，处理潜在变量Zt并通过SDE生成动态图。(c)是多步状态预测组件，包括动态GCN和时间注意力，以捕获图节点信号的时空特征并预测未来的多步状态。







在编码器阶段，历史 p 个时间步的特征矩阵 $X_{t−p:t−1}$ 被输入到两个 GCN 层中，以学习潜变量 $Z_{t−p:t−1}$ 的均值向量 u 和方差向量 logσ。所有时间序列共享相同的 GCN 参数，而 u 和 logσ 只共享第一层 GCN 参数，但保留各自的第二层参数。因此，可以通过这种方式获取潜在状态的后验概率分布。在解码器阶段，潜在状态的关系被视为扩散过程，并受到 SDE 的影响，SDE 被视为序列潜在状态的转换符合马尔可夫和高斯过程的先验。通过这种自适应机制可以推断邻节点的内部因果关系。因此，动态链接概率可以通过近似估计，动态因果图 $A_{causal}$ 的形成过程为 $p_θ(A^{t}_{causal}|Z^t , Z^{t−1} )$。为了减少预测链接的随机性，通过动态图和静态图之间的哈达玛积进行正则化。为了方便后续讨论，将应用 DVGNN-mask 来表示带有哈达玛积的模型，而没有哈达玛积的模型则称为 DVGNN。然后，转换密度概率的转换图 $A^{t−p:t−1}_{trans}$ 通过高斯分布进行计算。最后，$A^{t−p:t−1}_{trans}$ 与历史 p−1 个时间序列的特征矩阵一起被采样并输入到动态 GCNs 中以捕获空间特征，同时采用时间注意力来捕获时间特征。在神经网络的末端，应用残差连接来产生预测值 ^Xt:t+T0−1。

> 哈达玛积：也称为逐元素乘积，是一种逐元素进行相乘的运算。对于两个相同维度的矩阵或向量，进行哈达玛积时，对应位置上的元素相乘，得到一个具有相同维度的矩阵或向量。
>
> 正则化：是一种用于机器学习和统计建模中的技术，旨在防止过拟合并提高模型的泛化能力。它通过对模型的复杂度进行惩罚，来限制模型参数的大小，使得模型更加简单和稳定。



### A.图卷积网络

GCN 定义了基于图形局部谱滤波器的一阶近似。GCN 可表述为

![image-20240415193911541](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404151939597.png)

其中，拉普拉斯矩阵 $L = D^{-1/2} (A + I) D^{1/2}$，其中 I 是单位矩阵，D 是度矩阵。$h^{(l)} ∈ R^{N×F}$ 是第 l 层的输入，而 $h^{(l+1)} ∈ R^{N×E}$ 是第 l 层的输出，具有嵌入特征 E。此外，$w ∈ R^{F×E}$ 是学习参数，σ 是激活函数。



### B.变分图自动编码器

变分图自动编码器（VGAE）是链接预测和图生成任务中强大的生成式无监督学习方法。VGAE利用编码器将先验投影到一个潜在空间中，从中解码器可以进行采样。VGAE由两个模型组成，称为推理模型和生成模型，或者编码器和解码器阶段。

在图推理模型中，潜在变量 Z 的后验分布通过两层GCN近似为高斯分布，如下所示：

![image-20240415200941828](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152009888.png)

在这里，$u = GCN_u(X, \bar{A})$; $log σ = GCN_σ(X; \bar{A})$. 在本文中，GCN 层被定义为 $GCN(X; \bar{A}) = Sigmoid(L(ReLU(LXW_0))W_1)$。

在生成模型中，图的链接概率由潜在变量之间的内积给出，如下所示：

![image-20240415201520199](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152015268.png)

其中，$A_{ij}$ 是 $A_{causal}$ 的元素，σ 是激活函数，如 Sigmoid 或 ReLU 函数。

> Link Prediction：是一个 Graph 问题，它的目标是根据已知的节点和边，得到新的边（的权值/特征）

### C.VGAE2Seq 模型

VGAE 是一个强大的无监督和生成学习工具，在链接预测中表现出色，但不适用于处理时间序列问题。为了处理时间序列数据，我们在编码器阶段扩展了先前的 Definition 5 如下：

![image-20240415203825202](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152038266.png)

此外，我们假设潜在变量 $Z_t$ 服从高斯分布。在解码阶段，传统的 VGAE 属于非概率性变体，它仅通过潜在变量之间的内积来预测链接。这种图生成方法不适用于时空数据，因为节点之间的链接模式不能仅通过相邻节点的潜在变量的相似性来简单分类。因此，传统的 VGAE 方法受限于挖掘空间-时间特征，如具有复杂图结构的时间序列。为了发现图的动态因果关系，受贝叶斯框架的启发，并假设所有边相互独立，动态链接概率可以如下形式进行表述：

![image-20240415210230506](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152102564.png)

与传统的 VGAE 类似，我们假设每个时间间隔的潜在变量 $Z_t$ 服从标准高斯先验分布，即 $p(Z^t) = \prod_{i} p(z_{i}^{t}) = \prod_{i} \mathcal{N}(z_{i}| 0, 1)$。与 VGAE 相同，时间序列 VGAE 通过最大化证据下界（ELBO）来学习参数 θ 和 φ：

> KL散度(Kullback-Leibler Divergence)：是用来度量两个概率分布相似度的指标
>
> ELBO证据下界：优化问题的求解思路。优化目标很明确，减小KL散度的值即可。然而不幸的是，KL的表达式中依然有一部分不可求的后验概率。这就是为什么会有ELBO的存在原因。利用下面的等式，ELBO中只包括[联合概率](https://www.zhihu.com/search?q=联合概率&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType"%3A"answer"%2C"sourceId"%3A331070683})p(z, x)和q(z; v)，从而摆脱后验概率。给定数据集后，最小化KL等价于最大化ELBO，因此ELBO的最大化过程结束时，对应获得的q(z;v*)，就成为了我们的最后输出。
>
> 变分推断：首先，我们的原始目标是，需要根据已有数据推断需要的分布p；当p不容易表达，不能直接求解时，可以尝试用变分推断的方法， 即，寻找容易表达和求解的分布q，当q和p的差距很小的时候，q就可以作为p的[近似分布](https://www.zhihu.com/search?q=近似分布&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType"%3A"answer"%2C"sourceId"%3A331070683})，成为输出结果了。在这个过程中，我们的关键点转变了，从“求分布”的推断问题，变成了“缩小距离”的优化问题。

![image-20240415213309567](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152133638.png)

$KL[q_\phi (·)||p(·)]$代表$q_\phi(·)$和$p(·)$之间的Kullback-Leibler散度。考虑到p个时间序列，训练阶段的总目标函数将是：

![image-20240415213445259](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152134344.png)

我们开发了一种新的VGAE来处理时空数据，但如何找出邻居节点之间的链接概率成为了关键问题。

### D.具有扩散过程的动态链接概率

在真实场景中，时间序列数据不可避免地存在不确定性，并伴随着由数据收集传感器引起的噪声，这种噪声在数据收集阶段普遍存在。因此，将邻居节点之间的相互作用视为随机过程将更适合确定它们之间的因果关系，这是解码阶段的关键。

受物理领域扩散模型的启发，我们引入了解码阶段的推断扩散过程。

这种扩散过程可以建模为解决噪声驱动的随机微分方程（SDE）[42]。对于时空预测问题，考虑一个一般形式的线性随机微分方程，如下所示：

![image-20240415214656476](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152146545.png)

其中，$Z^t\in R^N$ 是状态，F(t) 和 L(t) 是时间的矩阵值函数，$u(t) \in R^N$ 是输入向量，而 $β(t) \in R^N$ 是扩散矩阵 Q 的布朗运动。在本文中，我们假设潜变量 $Z^t$ 遵循马尔可夫过程 $p(Z^t | Z^{t−1} , Z^{t−2}, ...Z^1 ) = p(Z^t |Z^{t−1} )$，且整个图中输入向量为零$（u(t) = 0）$。然后，如果我们将潜变量 Z 视为受方程式11控制的扩散过程，则方程式8的动态链接概率将被视为 $Z^t$ 和 $Z^{t−1}$ 的联合概率。

转移密度 $p_θ(Z^t |Z^{t−1} )$ 遵循高斯过程（GP）。因此，解是布朗运动的线性变换，是高斯分布。解可以表示为：

![image-20240415220548171](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202404152205245.png)

其中，$Σ_θ$ 是高斯过程的协方差矩阵，$Q = L_θL^T_θ$ 是扩散矩阵，Ψ 是转移矩阵，一般情况下没有闭合形式的表达式，但通过以下属性定义：



































































