# DIFFUSION CONVOLUTIONAL RECURRENT NEURAL NETWORK: DATA-DRIVEN TRAFFIC FORECASTING

**扩散卷积循环神经网络：基于数据的交通预测**

## 摘要

时空预测在神经科学、气候和交通领域有着广泛的应用。交通预测是此类学习任务的一个典型例子。该任务具有挑战性，原因在于==（1）道路网络上的复杂空间依赖性，（2）道路条件变化引起的非线性时间动态，以及（3）长期预测固有的难度==。为了应对这些挑战，我们提出将==交通流建模为有向图上的扩散过程==，并引入扩散卷积循环神经网络（DCRNN），这是一种用于交通预测的深度学习框架，它结合了交通流中的空间和时间依赖性。具体来说，==DCRNN使用图上的双向随机游走来捕获空间依赖性==，并==使用带有计划采样的编码器-解码器架构来捕获时间依赖性==。我们在两个现实世界的大规模道路网络交通数据集上评估了该框架，并观察到与最先进基线相比，性能一致提升了12%至15%。



## 一、介绍

时空预测是动态环境中运行的学习系统的一项关键任务。它有着广泛的应用范围，包括自动驾驶汽车操作、能源和智能电网优化、物流以及供应链管理。在本文中，我们研究了一个重要的任务：道路网络上的交通预测，这是智能交通系统的核心组件。

交通预测的目标是根据历史交通速度和基础道路网络来预测传感器网络的未来交通速度。

这项任务之所以具有挑战性，主要是因为复杂的时空依赖性和长期预测的内在困难。一方面，交通时间序列显示出强烈的时间动态性。重复出现的事件，如高峰时段或事故，可能导致非平稳性，使得长期预测变得困难。另一方面，道路上的传感器包含复杂但独特的空间相关性。图1展示了一个例子。道路1和道路2是相关的，而道路1和道路3则不是。虽然道路1和道路3在欧几里得空间中很接近，但它们表现出非常不同的行为。此外，未来的交通速度更多地受到下游交通的影响，而不是上游交通的影响。这意味着交通中的空间结构是非欧几里得的和有方向的。

交通预测已经研究了数十年，主要归为两类：知识驱动的方法和数据驱动的方法。在交通和运营研究中，知识驱动的方法通常应用排队理论并模拟交通中的用户行为（Cascetta, 2013）。

在时间序列分析领域，数据驱动的方法如自回归积分滑动平均（ARIMA）模型和卡尔曼滤波仍然很受欢迎（Liu et al, 2011; Lippi et al, 2013）。然而，简单的时间序列模型通常依赖于平稳性假设，而交通数据常常违反这一假设。最近，Lv等人（2015）和Yu等人（2017b）开发了用于交通预测的深度学习模型，但没有考虑空间结构。Wu和Tan（2016）以及Ma等人（2017）使用卷积神经网络（CNN）来模拟空间相关性，但这些空间结构是在欧几里得空间（例如，2D图像）中。Bruna等人（2014）和Defferrard等人（2016）研究了图卷积，但仅限于==无向图==。

在这项工作中，我们==使用有向图来表示交通传感器之间的成对空间相关性==，其中有向图的节点是传感器，边权重表示由道路网络距离测量的传感器对之间的接近程度。我们将==交通流的动态建模为扩散过程，并提出了扩散卷积操作来捕获空间依赖性==。我们进一步提出了扩散卷积循环神经网络（DCRNN），该网络集成了扩散卷积、序列到序列架构和计划采样技术。在真实世界的交通数据集上评估时，DCRNN始终大幅优于最先进的交通预测基线。总结如下：

+ 我们研究了交通预测问题，并==将交通的空间依赖性建模为有向图上的扩散过程==。我们提出了==扩散卷积==，它具有直观的解释并且可以有效地计算。

+ 我们提出了扩散卷积循环神经网络（DCRNN），这是一种整体方法，它使用扩散卷积和序列到序列学习框架以及==计划采样技术==来捕获时间序列中的空间和时间依赖性。DCRNN不仅限于交通领域，还很容易应用于其他时空预测任务。

+ 我们在两个大规模的真实世界数据集上进行了广泛的实验，所提出的方法在性能上显著优于最先进的基线方法。



## 二、方法论

我们明确了时空交通预测的学习问题，并描述了如何使用扩散卷积循环神经网络对依赖结构进行建模。

### 2.1 交通预测问题

交通预测的目标是，根据先前观察到的路网中N个相关传感器的交通流，来预测未来的交通速度。我们可以将传感器网络表示为加权有向图G = (V, E, W)，其中V是一组节点，|V| = N，E是一组边，而W ∈ R(N×N) 是一个加权邻接矩阵，表示节点的接近度（例如，它们路网距离的函数）。将G上观察到的交通流表示为图信号X ∈ R(N×P)，其中P是每个节点的特征数（例如，速度、容量）。令X(t)表示在时间t观察到的图信号，交通预测问题的目标是学习一个函数h(·)，该函数在给定图G的情况下，将T0个历史图信号映射到未来T个图信号：[X(t−T0+1);...;X(t);G] → h(·) → [X(t+1);...;X(t+T)]。

### 2.2 空间依赖性建模

我们通过将交通流量与扩散过程相关联来模拟空间依赖性，这明确捕捉了交通动态的随机性。这个扩散过程的特点是在具有重启概率α（α在[0, 1]之间）的图G上进行随机游走，并且具有状态转移矩阵$D^{-1}_OW$。这里$D_O = diag(W1)$是出度对角矩阵，$1\in R^{N}$表示全一向量。经过多个时间步后，这样的马尔可夫过程收敛到一个平稳分布P ∈ R{N×N}，其第i行$P_{i,:} ∈ R^{N}$代表了从节点$v_i ∈ V$扩散的可能性，因此也代表了与节点$v_i$的邻近性。以下引理为平稳分布提供了一个封闭形式的解。

**引理 2.1.**（Teng 等人，2016）扩散过程的平稳分布可以表示为图上无限随机游走的加权组合，并且可以以封闭形式计算得出：

![image-20240617113037586](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202406171130737.png)

其中k是扩散步骤。在实践中，我们使用扩散过程的有限K步截断，并为每一步分配一个可训练的权重。我们还包括反向扩散过程，使得双向扩散为模型提供了更多的灵活性，以捕获来自上游和下游交通的影响。

**扩散卷积** 在图信号 $X ∈ R^{N×P}$ 和滤波器 $f_θ$ 上的扩散卷积操作定义为：

![image-20240617113947614](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202406171139699.png)

其中 $θ ∈ R^{K×2}$ 是滤波器的参数，$D^{-1}_OW$ 和 $D^{-1}_IW$ 分别表示扩散过程和其反向过程的转移矩阵。一般来说，计算卷积可能很昂贵。但是，如果图 G 是稀疏的，那么可以使用 O(K) 次递归的稀疏-稠密矩阵乘法来高效地计算等式 2，总时间复杂度为 O(KjEj)，这远远小于 O(N2)。

详情见附录 B。

**扩散卷积层** 通过定义在等式 2 中的卷积操作，我们可以构建一个扩散卷积层，它将 P 维特征映射到 Q 维输出。

记参数张量为 $Θ ∈ R^{Q×P×K×2} = [θ]_{q;p}$，其中 $Θ_{q;p;:;:} ∈ R^{K×2}$ 参数化了第 p 个输入和第 q 个输出的卷积滤波器。因此，扩散卷积层是：

![image-20240617115410008](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202406171154063.png)

其中 $X ∈ R^{N×P}$ 是输入，$H ∈ R^{N×Q}$ 是输出，$f_{θ_{q;p};;:}$ 是滤波器，而 a 是激活函数（例如，ReLU、Sigmoid）。扩散卷积层学习图结构数据的表示，并且我们可以使用基于随机梯度的方法来训练它。

**与谱图卷积的关系** 扩散卷积既可以定义在有向图上，也可以定义在无向图上。当应用于无向图时，我们展示了包括流行的谱图卷积（即 ChebNet（Defferrard 等人，2016））在内的许多现有的图结构卷积操作都可以被视为扩散卷积的一个特例（直到相似变换）。设 D 为度矩阵，L = D−1/2(D − W)D−1/2 为归一化图拉普拉斯矩阵，以下命题展示了这种联系。

**命题2.2** 定义为谱图卷积

![image-20240617115642368](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202406171156415.png)

命题2.2. 当图 G 是无向图时，定义为特征值分解 $L = ΦΛΦ^T$（其中 Φ 是特征向量矩阵，Λ 是对角矩阵，其元素为特征值）和 $F(θ) = ∑_{k=0}^{K-1} θ_kΛ^k$ 的谱图卷积，经过相似变换后，等价于图扩散卷积。

证明：见附录C。

### 2.3 时间动态建模

我们利用循环神经网络（RNNs）来建模时间依赖性。具体来说，我们使用了门控循环单元（GRU）（Chung等人，2014年），它是RNNs的一个简单但功能强大的变体。我们将GRU中的矩阵乘法替换为扩散卷积，从而得到了我们提出的扩散卷积门控循环单元（DCGRU）。

![image-20240617163858619](https://raw.githubusercontent.com/Quinlan7/pic_cloud/main/img/202406171638736.png)

其中，X(t) 和 H(t) 分别表示时间 t 时的输入和输出，r(t) 和 u(t) 分别表示时间 t 时的重置门和更新门。?G 表示在方程2中定义的扩散卷积，而Θr、Θu、ΘC 是对应滤波器的参数。与GRU类似，DCGRU可以用于构建循环神经网络层，并通过时间反向传播进行训练。

在多步预测中，我们采用了序列到序列（Sequence to Sequence）架构（Sutskever等人，2014年）。编码器和解码器都是带有DCGRU的循环神经网络。在训练过程中，我们将历史时间序列输入到编码器中，并使用其最终状态来初始化解码器。解码器根据先前的真实观测值生成预测。在测试时，真实观测值被模型自身生成的预测值所替代。训练和测试输入分布之间的差异可能会导致性能下降。为了缓解这个问题，我们将计划采样（scheduled sampling）（Bengio等人，2015年）集成到模型中，我们在第i次迭代中以概率i输入真实观测值，或以概率1-i输入模型生成的预测值。在训练过程中，i逐渐减小到0，以便模型学习测试分布。

通过空间和时间建模，我们构建了扩散卷积循环神经网络（DCRNN）。DCRNN的模型架构如图2所示。整个网络通过最大化生成目标未来时间序列的似然性来训练，这通过时间反向传播实现。DCRNN能够捕获时间序列之间的时空依赖性，并可以应用于各种时空预测问题。



## 三、相关工作

交通预测是交通和运筹学中的经典问题，主要基于排队理论和模拟（Drew，1968）。基于数据的交通预测方法受到了广泛的关注，最近的综述文章（Vlahogianni等人，2014）及其参考文献中可以找到更多详细信息。然而，现有的机器学习模型要么对数据强加严格的平稳性假设（例如，自回归模型），要么无法解释高度非线性的时间依赖性（例如，潜在空间模型 Yu 等人（2016）；Deng 等人（2016））。

深度学习模型为时间序列预测问题提供了新的希望。例如，在 Yu 等人（2017b）；Laptev 等人（2017）的研究中，作者使用深度循环神经网络（RNN）来研究时间序列预测。卷积神经网络（CNN）也被应用于交通预测。Zhang 等人（2016；2017）将道路网络转换为常规的二维网格，并应用传统的CNN来预测人群流量。Cheng 等人（2017）提出了DeepTransport，它通过对每条道路的上游和下游邻近道路进行明确收集来建模空间依赖性，然后分别对这些邻域进行卷积操作。

最近，基于谱图理论的卷积神经网络（CNN）已经被推广到任意图上。图卷积神经网络（GCN）首先在Bruna等人（2014）中被引入，它架起了谱图理论和深度神经网络之间的桥梁。Defferrard等人（2016）提出了ChebNet，通过快速局部卷积滤波器改进了GCN。Kipf和Welling（2017）简化了ChebNet，并在半监督分类任务中取得了最先进的性能。Seo等人（2016）将ChebNet与循环神经网络（RNN）结合用于结构化序列建模。Yu等人（2017a）将传感器网络建模为无向图，并应用了ChebNet和卷积序列模型（Gehring等人，2017）来进行预测。提到的基于谱的卷积的一个限制是，它们通常需要图是无向的，以便计算有意义的谱分解。从谱域到顶点域，Atwood和Towsley（2016）提出了扩散卷积神经网络（DCNN），它将卷积定义为图结构输入中每个节点的扩散过程。Hechtlinger等人（2017）提出了GraphCNN，通过将每个节点与其p个最近邻节点进行卷积，将卷积推广到图上。然而，这两种方法都没有考虑时间动态，主要处理静态图设置。

我们的方法与上述所有方法都不同，原因在于问题的设置以及在图上卷积的公式化。我们将传感器网络建模为加权有向图，这比网格或无向图更现实。此外，提出的卷积是通过双向图随机游走定义的，并进一步与序列到序列学习框架以及计划采样相结合，以模拟长期的时间依赖性。

## 四、实验

我们在两个真实世界的大规模数据集上进行了实验：（1）METR-LA 这个交通数据集包含了从洛杉矶县高速公路的环路检测器收集的交通信息（Jagadish等人，2014）。我们选择了207个传感器，并收集了从2012年3月1日到2012年6月30日的4个月数据进行实验。（2）PEMS-BAY 这个交通数据集是由加利福尼亚州交通局（CalTrans）性能测量系统（PeMS）收集的。我们选择了湾区内的325个传感器，并收集了从2017年1月1日到2017年5月31日的6个月数据进行实验。两个数据集的传感器分布都在附录的图8中进行了可视化。

在这两个数据集中，我们都将交通速度读数汇总为5分钟的时间窗口，并应用了Z-Score标准化。其中70%的数据用于训练，20%用于测试，剩下的10%用于验证。为了构建传感器图，我们计算了传感器之间的成对路网距离，并使用阈值高斯核（Shuman等人，2013）构建邻接矩阵。如果dist(vi; vj) ≤ κ，则Wij = exp(-dist(vi; vj)2 / σ2)，否则为0；其中Wij表示传感器vi和传感器vj之间的边权重，dist(vi; vj)表示从传感器vi到传感器vj的路网距离。σ是距离的标准差，κ是阈值。

### 4.1 实验设置

基线方法 我们将DCRNN1与广泛使用的时间序列回归模型进行比较，包括（1）HA：历史平均值（Historical Average），它将交通流建模为季节性过程，并使用之前季节的加权平均值作为预测；（2）ARIMAkal：带有卡尔曼滤波器的自回归综合移动平均模型（Auto-Regressive Integrated Moving Average model with Kalman filter），该模型在时间序列预测中广泛使用；（3）VAR：向量自回归（Vector Auto-Regression）（Hamilton, 1994）。（4）SVR：支持向量回归（Support Vector Regression），它使用线性支持向量机进行回归任务；以下基于深度神经网络的方法也包括在内：（5）前馈神经网络（FNN）：具有两个隐藏层和L2正则化的前馈神经网络。（6）具有全连接LSTM隐藏单元的循环神经网络（FC-LSTM）（Sutskever等人，2014）。

所有基于神经网络的方法都使用Tensorflow（Abadi等人，2016）实现，并使用Adam优化器和学习率衰减进行训练。最佳超参数通过验证数据集上的树结构Parzen估计器（TPE）（Bergstra等人，2011）选择。

DCRNN以及基线方法的详细参数设置在附录E中提供。

### 4.2 实验性能比较

表1显示了不同方法在提前15分钟、30分钟和1小时预测两个数据集时的比较。这些方法是根据交通预测中常用的三个指标来评估的，包括（1）平均绝对误差（MAE），（2）平均绝对百分比误差（MAPE），和（3）均方根误差（RMSE）。在计算这些指标时，排除了缺失值。这些指标的详细公式在附录E.2中提供。我们在两个数据集中都观察到了以下现象。（1）基于RNN的方法，包括FC-LSTM和DCRNN，通常比其他基线方法表现更好，这强调了建模时间依赖性的重要性。（2）在所有预测范围内，DCRNN在所有指标上都取得了最佳性能，这表明了时空依赖建模的有效性。（3）对于长期预测，如提前1小时，基于深度神经网络的方法（包括FNN、FC-LSTM和DCRNN）往往比线性基线方法表现更好。这是因为随着预测范围的增加，时间依赖性变得越来越非线性。此外，由于历史平均方法不依赖于短期数据，因此其性能对预测范围的微小增加保持不变。

请注意，在METR-LA（洛杉矶，以其复杂的交通状况而闻名）数据集上进行交通预测比在PEMS-BAY（湾区）数据集上更具挑战性。因此，我们在后续实验中默认使用METR-LA数据集。

### 4.3 空间依赖建模的影响

为了进一步探究空间依赖建模的影响，我们将DCRNN与以下变体进行了比较：（1）DCRNN-NoConv，它通过用单位矩阵替换扩散卷积（方程2）中的转移矩阵来忽略空间依赖。这本质上意味着传感器的预测只能根据其自身的历史读数进行推断；（2）DCRNN-UniConv，它仅使用前向随机游走的转移矩阵进行扩散卷积。图3展示了这三个模型的学习曲线，这些模型具有大致相同数量的参数。没有扩散卷积的DCRNN-NoConv具有更高的验证误差。此外，DCRNN达到了最低的验证误差，这显示了使用双向随机游走的有效性。直觉上，双向随机游走使模型能够捕捉来自上游和下游交通的影响，并具有这种能力和灵活性。

接下来，为了研究图结构构建的影响，我们通过设置`Wcij = cWji = max(Wij; Wji)`来构建一个无向图，其中`Wc`是新的对称权重矩阵。然后，我们开发了DCRNN的一个变体，称为GCRNN，它使用序列到序列学习结合ChebNet图卷积（方程5），参数数量大致相同。表2展示了在METR-LA数据集中DCRNN和GCRNN的比较。DCRNN始终优于GCRNN。

直觉上，有向图能更好地捕捉交通传感器之间的非对称相关性。

图4展示了不同参数的影响。K大致对应于滤波器接收域的大小，而单元数对应于滤波器的数量。较大的K使模型能够捕获更广泛的空间依赖，但代价是增加了学习复杂度。我们观察到，随着K的增加，验证数据集上的误差首先迅速下降，然后略有上升。对于改变单元数量的情况，也观察到了类似的行为。

为了研究图结构构建的影响，我们通过设置 `Wcij = cWji = max(Wij, Wji)` 来构造一个无向图，其中 `Wc` 是新的对称权重矩阵。然后，我们开发了DCRNN的一个变体，称为GCRNN，它使用序列到序列学习与ChebNet图卷积（方程5），并且具有大致相同的参数数量。表2展示了在METR-LA数据集中DCRNN和GCRNN的比较。DCRNN始终优于GCRNN。

直觉上，有向图能更好地捕捉交通传感器之间的非对称相关性。

图4展示了不同参数的影响。K大致对应于滤波器接收域的大小，而单元数对应于滤波器的数量。较大的K使模型能够捕获更广泛的空间依赖，但代价是增加了学习复杂度。我们观察到，随着K的增加，验证数据集上的误差首先迅速下降，然后略有上升。对于改变单元数量的情况，也观察到了类似的行为。

### 4.4 时间依赖建模的影响

为了评估包括序列到序列框架和计划采样机制在内的时间建模效果，我们进一步设计了DCRNN的三个变体：（1）DCNN：我们将历史观测值连接成一个固定长度的向量，并将其输入到堆叠的扩散卷积层中，以预测未来的时间序列。我们训练一个模型来进行一步预测，并将之前的预测作为输入馈送到模型中进行多步预测。（2）DCRNN-SEQ：它使用编码器-解码器序列到序列学习框架来进行多步预测。（3）DCRNN：与DCRNN-SEQ类似，但增加了计划采样。图5展示了这四种方法在不同预测范围上的平均绝对误差（MAE）比较。我们观察到：（1）DCRNN-SEQ在性能上大幅超越了DCNN，这证明了建模时间依赖性的重要性。（2）DCRNN取得了最好的结果，并且随着预测范围的增加，其优势变得更加明显。这主要是因为模型在训练过程中学会了处理多步预测中的错误，因此较少受到误差传播问题的影响。我们还训练了一个模型，该模型在进行多步预测时始终将其输出作为输入。然而，其性能远差于这三个变体，这强调了计划采样的重要性。

### 4.5 模型解释

为了更好地理解模型，我们可视化了预测结果以及学习到的滤波器。图6展示了1小时前预测的可视化结果。我们有以下观察：（1）当交通速度存在小幅度波动时，DCRNN能够生成平滑的平均速度预测（图6(a)）。这反映了模型的鲁棒性。（2）与基线方法（例如FC-LSTM）相比，DCRNN更有可能准确预测交通速度的突变。如图6(b)所示，DCRNN预测了高峰小时的开始和结束。这是因为DCRNN捕获了空间依赖性，并能够利用附近传感器的速度变化进行更准确的预测。图7可视化了以不同节点为中心的学习到的滤波器示例。星号表示中心，颜色表示权重。我们可以观察到（1）权重在中心周围很好地局部化了，（2）权重根据道路网络距离进行扩散。

附录F中提供了更多可视化示例。

## 五、总结

在本文中，我们将路网上的交通预测问题视为一个时空预测问题，并提出了扩散卷积循环神经网络来捕获时空依赖性。具体而言，我们使用双向图随机游走来建模空间依赖性，并使用循环神经网络来捕获时间动态。我们还整合了编码器-解码器架构和计划采样技术，以提高长期预测的性能。在评估两个大规模现实世界交通数据集时，我们的方法相比基线方法获得了显著更好的预测效果。对于未来的工作，我们将研究以下两个方面：（1）将所提出的模型应用于其他时空预测任务；（2）当基础图结构发生变化时（例如，移动对象的K最近邻图）建模时空依赖性。